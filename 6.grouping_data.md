## Задача 1

*С помощью оператора GROUP BY посчитайте количество курьеров мужского и женского пола в таблице couriers.*  
*Новую колонку с числом курьеров назовите couriers_count.*  
*Результат отсортируйте по этой колонке по возрастанию.*  

```sql
select 
  sex,
  count(*) as couriers_count
from couriers
group by 1
order by 2;
```

## Задача 2

*Посчитайте количество созданных и отменённых заказов в таблице user_actions.*  
*Новую колонку с числом заказов назовите orders_count.*  
*Результат отсортируйте по числу заказов по возрастанию.*  

```sql
select 
 action,
 count(*) as orders_count
from user_actions
group by 1
order by 2 
```

## Задача 3

*Используя группировку и функцию DATE_TRUNC, приведите все даты к началу месяца и посчитайте, сколько заказов было сделано в каждом из них.*  
*Расчёты проведите по таблице orders. Колонку с усечённой датой назовите month, колонку с количеством заказов — orders_count.*  
*Результат отсортируйте по месяцам — по возрастанию.*  

```sql
select
 date_trunc('month', creation_time) as month,
 count(*) as orders_count
from orders
group by 1
order by 1
```

## Задача 4

*Используя группировку и функцию DATE_TRUNC, приведите все даты к началу месяца и посчитайте, сколько заказов было сделано и сколько было отменено в каждом из них.*  
*В этот раз расчёты проведите по таблице user_actions. Колонку с усечённой датой назовите month, колонку с количеством заказов — orders_count.*  
*Результат отсортируйте сначала по месяцам — по возрастанию, затем по типу действия — тоже по возрастанию.*  

```sql
select
 date_trunc('month', time) as month,
 action,
 count(*) as orders_count
from user_actions
group by 1,2
order by 1,2
```

## Задача 5

*По данным в таблице users посчитайте максимальный порядковый номер месяца среди всех порядковых номеров месяцев рождения пользователей сервиса. С помощью группировки проведите расчёты отдельно в двух группах — для пользователей мужского и женского пола.*  
*Новую колонку с максимальным номером месяца рождения в группах назовите max_month. Преобразуйте значения в новой колонке в формат INTEGER, чтобы порядковый номер был выражен целым числом.*  
*Результат отсортируйте по колонке с полом пользователей.*  

```sql
select 
 sex,
 max(extract('month' from birth_date))::int as max_month
from users
group by 1
order by 1
```

## Задача 6

*По данным в таблице users посчитайте максимальный порядковый номер месяца рождения самого молодого пользователя сервиса. С помощью группировки проведите расчёты отдельно в двух группах — для пользователей мужского и женского пола.*  
*Новую колонку с максимальным номером месяца рождения в группах назовите max_month. Преобразуйте значения в новой колонке в формат INTEGER, чтобы порядковый номер был выражен целым числом.*  
*Результат отсортируйте по колонке с полом пользователей.*  

```sql
select 
 sex,
 extract('month' from max(birth_date))::int as max_month
from users
group by 1
order by 1
```

## Задача 7

*Посчитайте максимальный возраст пользователей мужского и женского пола в таблице users. Возраст измерьте числом полных лет.*  
*Новую колонку с возрастом назовите max_age. Преобразуйте значения в новой колонке в формат INTEGER, чтобы возраст был выражен целым числом.*  
*Результат отсортируйте по новой колонке по возрастанию возраста.*  

```sql
select 
 sex,
 date_part('year', max(age(birth_date)))::int as max_age
from users
group by 1
order by 2
```

## Задача 8

*Разбейте пользователей из таблицы users на группы по возрасту (возраст по-прежнему измеряем числом полных лет) и посчитайте количество пользователей каждого возраста.*  
*Колонку с возрастом назовите age, а колонку с числом пользователей — users_count. Преобразуйте значения в колонке с возрастом в формат INTEGER, чтобы возраст был выражен целым числом.*  
*Результат отсортируйте по колонке с возрастом по возрастанию.*  

```sql
select age, count(*) as users_count from (
 select 
  date_part('year', age(birth_date)) as age
 from users
 )t
group by 1
order by 1
```

## Задача 9

*Вновь разбейте пользователей из таблицы users на группы по возрасту (возраст по-прежнему измеряем количеством полных лет), только теперь добавьте в группировку ещё и пол пользователя. Затем посчитайте количество пользователей в каждой половозрастной группе.*  
*Все NULL значения в колонке birth_date заранее отфильтруйте с помощью WHERE.*  
*Колонку с возрастом назовите age, а колонку с числом пользователей — users_count, имя колонки с полом оставьте без изменений. Преобразуйте значения в колонке с возрастом в формат INTEGER, чтобы возраст был выражен целым числом.*  
*Отсортируйте полученную таблицу сначала по колонке с возрастом по возрастанию, затем по колонке с полом — тоже по возрастанию.*  

```sql
select 
 date_part('year', age(birth_date))::int as age,
 sex,
 count(*) as users_count
from users
where birth_date is not null
group by 1,2
order by 1, 2
```

## Задача 10

*Посчитайте количество товаров в каждом заказе, примените к этим значениям группировку и рассчитайте количество заказов в каждой группе за неделю с 29 августа по 4 сентября 2022 года включительно. Для расчётов используйте данные из таблицы orders.*  
*Выведите две колонки: размер заказа и число заказов такого размера за указанный период. Колонки назовите соответственно order_size и orders_count.*  
*Результат отсортируйте по возрастанию размера заказа.*  

```sql
select
 array_length(product_ids, 1) as order_size,
 count(*) as orders_count
from orders
where creation_time between '2022-08-29' and '2022-09-05'
group by 1
order by 1
```

## Задача 11

*Посчитайте количество товаров в каждом заказе, примените к этим значениям группировку и рассчитайте количество заказов в каждой группе. Учитывайте только заказы, оформленные по будням. В результат включите только те размеры заказов, общее число которых превышает 2000. Для расчётов используйте данные из таблицы orders.*  
*Выведите две колонки: размер заказа и число заказов такого размера. Колонки назовите соответственно order_size и orders_count.*  
*Результат отсортируйте по возрастанию размера заказа.*  

```sql
select
 array_length(product_ids, 1) as order_size,
 count(*) as orders_count
from orders
where extract(dow from creation_time) not in (0, 6)
group by 1
having count(*) > 2000
order by 1
```

## Задача 12

*По данным из таблицы user_actions определите пять пользователей, сделавших в августе 2022 года наибольшее количество заказов.*  
*Выведите две колонки — id пользователей и число оформленных ими заказов. Колонку с числом оформленных заказов назовите created_orders.*  
*Результат отсортируйте сначала по убыванию числа заказов, сделанных пятью пользователями, затем по возрастанию id этих пользователей.*  

```sql
select user_id, created_orders from (
 select
  user_id,
  count(*) as created_orders,
  row_number() over(order by count(*) desc) as rnk
 from user_actions
 where to_char(time, 'mm-yy') = '08-22'
  and action = 'create_order'
 group by 1
 )t 
where rnk < 6
order by 2 desc, 1
```

## Задача 13

*А теперь по данным таблицы courier_actions определите курьеров, которые в сентябре 2022 года доставили только по одному заказу.*  
*В этот раз выведите всего одну колонку с id курьеров. Колонку с числом заказов в результат включать не нужно.*  
*Результат отсортируйте по возрастанию id курьера.*  

```sql
select
 courier_id
from courier_actions
where to_char(time, 'mm-yy') = '09-22'
 and action = 'deliver_order'
group by 1
having count(*) = 1
order by 1
```

## Задача 14

*Из таблицы user_actions отберите пользователей, у которых последний заказ был создан до 8 сентября 2022 года.*  
*Выведите только их id, дату создания заказа выводить не нужно.*  
*Результат отсортируйте по возрастанию id пользователя.*  

```sql
select 
 user_id
from user_actions
where action = 'create_order'
group by user_id
having max(time) < '2022-09-08'
order by user_id
```

## Задача 15

*По данным из таблицы orders рассчитайте средний размер заказа по выходным и по будням.*  
*Группу с выходными днями (суббота и воскресенье) назовите «weekend», а группу с будними днями (с понедельника по пятницу) — «weekdays» (без кавычек).*  
*В результат включите две колонки: колонку с группами назовите week_part, а колонку со средним размером заказа — avg_order_size.*  
*Средний размер заказа округлите до двух знаков после запятой.*  
*Результат отсортируйте по колонке со средним размером заказа — по возрастанию*  

```sql
select 
 case when extract('dow' from creation_time) in (0, 6) then 'weekend' else 'weekdays' end as week_part,
 round(avg(array_length(product_ids, 1)), 2) as avg_order_size
from orders
group by 1
order by 2
```

## Задача 16

*Разбейте пользователей из таблицы users на 4 возрастные группы:*  
 - *от 19 до 24 лет;*  
 - *от 25 до 29 лет;*  
 - *от 30 до 35 лет;*  
 - *от 36 до 41 года.*  
*Посчитайте число пользователей, попавших в каждую возрастную группу. Группы назовите соответственно «19-24», «25-29», «30-35», «36-41» (без кавычек).*  
*Выведите наименования групп и число пользователей в них. Колонку с наименованием групп назовите group_age, а колонку с числом пользователей — users_count.*  
*Отсортируйте полученную таблицу по колонке с наименованием групп по возрастанию.*  

```sql
select * from (
 select 
  case when 24 >= date_part('year', age(birth_date)) and date_part('year', age(birth_date)) >= 19 then '19-24'
   when 29 >= date_part('year', age(birth_date)) and date_part('year', age(birth_date)) >= 25 then '25-29'
   when 35 >= date_part('year', age(birth_date)) and date_part('year', age(birth_date)) >= 30 then '30-35'
   when 41 >= date_part('year', age(birth_date)) and date_part('year', age(birth_date)) >= 36 then '36-41' end as group_age,
  count(*) as users_count
 from users
 group by 1
 order by 1
 )foo
where group_age is not null      
```

## Задача 17

*Для каждого пользователя в таблице user_actions посчитайте общее количество оформленных заказов и долю отменённых заказов.*  
*Новые колонки назовите соответственно orders_count и cancel_rate. Колонку с долей отменённых заказов округлите до двух знаков после запятой.*  
*В результат включите только тех пользователей, которые оформили больше трёх заказов и у которых показатель cancel_rate составляет не менее 0.5.*  
*Результат отсортируйте по возрастанию id пользователя.*  

```sql
select * from (
 select 
  user_id,  
  round(1.0 * count(order_id) filter (where action = 'cancel_order') / count(distinct order_id), 2) as cancel_rate,
  count(distinct order_id) as orders_count
 from user_actions
 group by 1
 )t
where orders_count > 3 
 and cancel_rate >= 0.5
order by user_id  
```

## Задача 18

*Для каждого дня недели в таблице user_actions посчитайте:*  
- *Общее количество оформленных заказов.*  
- *Общее количество отменённых заказов.*  
- *Общее количество неотменённых заказов (т.е. доставленных).*  
- *Долю неотменённых заказов в общем числе заказов (success rate).*  
*Новые колонки назовите соответственно created_orders, canceled_orders, actual_orders и success_rate. Колонку с долей неотменённых заказов округлите до трёх знаков после запятой.*  

```sql
with t as (
 select 
  extract(isodow from time)::int as weekday_number,
  to_char(time, 'Dy') as weekday,
  count(distinct order_id) as created_orders,
  count(*) filter (where action = 'cancel_order') as canceled_orders
 from user_actions ua
 where time >= '2022-08-24' and time <= '2022-09-07'
 group by weekday_number, weekday
)
select *,
 created_orders - canceled_orders as actual_orders,
 round(1.0 * (created_orders - canceled_orders) / created_orders, 3) as success_rate
from t
order by weekday_number 
```